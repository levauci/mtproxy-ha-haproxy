---
- name: Deploy MTProxy HA stack
  hosts: all
  become: true
  vars_files:
    - ../group_vars/all.yml
  tasks:
    - name: Install base packages and Docker
      ansible.builtin.include_role:
        name: common
      tags: [common, setup]

    - name: Flush handlers (common)
      ansible.builtin.meta: flush_handlers

    - name: Configure TPROXY routing
      ansible.builtin.include_role:
        name: tproxy
      tags: [tproxy, setup]

    - name: Flush handlers (tproxy)
      ansible.builtin.meta: flush_handlers

    - name: Launch MTProxy containers
      ansible.builtin.include_role:
        name: mtproxy
      tags: [mtproxy, scale]

    - name: Flush handlers (mtproxy)
      ansible.builtin.meta: flush_handlers

    - name: Configure HAProxy
      ansible.builtin.include_role:
        name: haproxy
      tags: [haproxy, config, scale]

    - name: Flush handlers (haproxy)
      ansible.builtin.meta: flush_handlers

    - name: Run smoke tests
      ansible.builtin.include_role:
        name: verify
      tags: [verify]
