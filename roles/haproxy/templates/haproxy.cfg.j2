global
    maxconn 10000
    log /dev/log local0
    stats socket /run/haproxy/admin.sock user haproxy group haproxy mode 660 level admin
    stats timeout 30s

defaults
    mode tcp
    option dontlognull
    timeout connect 5s
    timeout client  1m
    timeout server  1m
    log global

# Stats (optional, for failover verification)
listen stats
    mode http
    bind *:{{ haproxy_stats_port | default(8404) }}
    stats enable
    stats uri /stats
    stats refresh 5s

frontend mtproto_in
    bind *:{{ haproxy_port }} transparent
    mode tcp
    default_backend mtproxies

backend mtproxies
    balance {{ haproxy_balance_algorithm | default('leastconn') }}
    source 0.0.0.0 usesrc clientip
    option tcp-check
    option log-health-checks
    tcp-check connect
{% for i in range(1, (mtproxy_replicas | int) + 1) %}
    server mtp{{ i }} 127.0.0.1:{{ mtproxy_base_port + i - 1 }} check inter 2000 fall 3 rise 2
{% endfor %}
