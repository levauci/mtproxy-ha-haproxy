global
    daemon
    maxconn 10000
    log /dev/log local0
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s

defaults
    mode tcp
    timeout connect 5s
    timeout client  1m
    timeout server  1m
    log global

# Stats (optional, for failover verification)
listen stats
    mode http
    bind *:{{ haproxy_stats_port | default(8404) }}
    stats enable
    stats uri /stats
    stats refresh 5s

frontend mtproto_in
    bind *:{{ haproxy_port }} transparent
    mode tcp
    default_backend mtproxies

backend mtproxies
    balance leastconn
    option tcp-check
    tcp-check connect port 443
{% for i in range(mtproxy_replicas | int) %}
    server mtp{{ i }} 127.0.0.1:{{ mtproxy_base_port + i }} check inter 2000 fall 3 rise 2 transparent
{% endfor %}
