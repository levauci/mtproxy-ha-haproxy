#!/usr/bin/env bash
set -euo pipefail

CHAIN="HAPROXY_TPROXY"
MARK="{{ tproxy_fwmark }}"
ROUTE_TABLE="{{ tproxy_route_table }}"
PORT="{{ haproxy_port }}"

ip rule del fwmark "${MARK}" lookup "${ROUTE_TABLE}" 2>/dev/null || true
ip rule add fwmark "${MARK}" lookup "${ROUTE_TABLE}"
ip route replace local 0.0.0.0/0 dev lo table "${ROUTE_TABLE}"

iptables -t mangle -N "${CHAIN}" 2>/dev/null || true
iptables -t mangle -F "${CHAIN}"
iptables -t mangle -A "${CHAIN}" \
  -p tcp \
  -j TPROXY \
  --tproxy-mark "0x${MARK}/0x${MARK}" \
  --on-port "${PORT}" \
  --on-ip 0.0.0.0

iptables -t mangle -D PREROUTING -p tcp --dport "${PORT}" -j "${CHAIN}" 2>/dev/null || true
iptables -t mangle -A PREROUTING -p tcp --dport "${PORT}" -j "${CHAIN}"
