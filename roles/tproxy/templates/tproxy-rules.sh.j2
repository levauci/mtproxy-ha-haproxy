#!/usr/bin/env bash
set -euo pipefail

CHAIN="HAPROXY_TPROXY"
MARK="{{ tproxy_fwmark | default('1') }}"
ROUTE_TABLE="{{ tproxy_route_table | default('100') }}"
PORT="{{ haproxy_port }}"

# Idempotent policy-routing setup for marked packets.
if ! ip rule show | grep -q "fwmark 0x${MARK} lookup ${ROUTE_TABLE}"; then
  ip rule add fwmark "${MARK}" lookup "${ROUTE_TABLE}"
fi

if ! ip route show table "${ROUTE_TABLE}" | grep -q "local 0.0.0.0/0 dev lo"; then
  ip route add local 0.0.0.0/0 dev lo table "${ROUTE_TABLE}"
fi

# Keep TPROXY logic isolated in its own chain, without flushing all mangle rules.
iptables -t mangle -N "${CHAIN}" 2>/dev/null || true
iptables -t mangle -F "${CHAIN}"
iptables -t mangle -A "${CHAIN}" \
  -p tcp \
  -j TPROXY \
  --tproxy-mark "0x${MARK}/0x${MARK}" \
  --on-port "${PORT}" \
  --on-ip 0.0.0.0

iptables -t mangle -D PREROUTING -p tcp --dport "${PORT}" -j "${CHAIN}" 2>/dev/null || true
iptables -t mangle -A PREROUTING -p tcp --dport "${PORT}" -j "${CHAIN}"
